#!/usr/bin/env ruby
# F5 Device
# ===
#
# Collects Metrics via SNMP for a Switchvox PBX
#   - Sucscription Days Left
#
# DEPENDENCIES:
#   gem: sensu-plugin
#   gem: snmp
#
# USAGE:
#
#   check-switchvox-pbx  -h host -C community -p prefix
#
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| Name                                 | OID                               | Description                                                                                                                                                                         |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysStatMemoryTotald                  | .1.3.6.1.4.1.3375.2.1.1.2.1.44    | The total host memory in bytes for the system                                                                                                                                       |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysStatMemoryUsed                    | .1.3.6.1.4.1.3375.2.1.1.2.1.45    | The memory in use in bytes for TMM (Traffic Management Module)                                                                                                                      |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalHostMemTotal                | .1.3.6.1.4.1.3375.2.1.1.2.20.2    | The total host memory in bytes for the system                                                                                                                                       |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalHostMemUsed                 | .1.3.6.1.4.1.3375.2.1.1.2.20.3    | The host memory in bytes currently in use for the system                                                                                                                            |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalHostSwapTotal               | .1.3.6.1.4.1.3375.2.1.1.2.20.46   | The total swap in bytes for the system                                                                                                                                              |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalHostSwapUsed                | .1.3.6.1.4.1.3375.2.1.1.2.20.46.0 | The swap in bytes currently in use for the system                                                                                                                                   |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysMultiHostCpuUsageRatio            | .1.3.6.1.4.1.3375.2.1.7.5.2.1.11  | This is usage ratio of CPU for the associated host. This value indicates the present cpu usage. For usage computed over specific intervals, please use the specific (5s,1m,5m) OIDs |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalHostCpuUsageRatio           | .1.3.6.1.4.1.3375.2.1.1.2.20.13   | This is usage ratio of CPU for the system. It is calculated by (sum of deltas for user, niced, system)/(sum of deltas of user, niced, system, idle, irq, softirq, andiowait)        |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalHostCpuUser                 | .1.3.6.1.4.1.3375.2.1.1.2.20.6    | The average time spent by all processors in user context for the system                                                                                                             |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalHostCpuNice                 | .1.3.6.1.4.1.3375.2.1.1.2.20.7    | The average time spent by all processors running niced processes for the system                                                                                                     |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalHostCpuSystem               | .1.3.6.1.4.1.3375.2.1.1.2.20.8    | The average time spent by all processors servicing system calls for the system                                                                                                      |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalHostCpuIdle                 | .1.3.6.1.4.1.3375.2.1.1.2.20.9    | The average time spent by all processors doing nothing for the system                                                                                                               |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalHostCpuIrq                  | .1.3.6.1.4.1.3375.2.1.1.2.20.10   | The average time spent by all processors servicing hardware interrupts for the system                                                                                               |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalHostCpuSoftirq              | .1.3.6.1.4.1.3375.2.1.1.2.20.11   | The average time spent by all processors servicing soft interrupts for the system                                                                                                   |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalHostCpuIowait               | .1.3.6.1.4.1.3375.2.1.1.2.20.12   | The average time spent by all processors waiting for external I/O to complete for the system                                                                                        |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalHostCpuStolen               | .1.3.6.1.4.1.3375.2.1.1.2.20.38   | The time 'stolen' from the system (for virtual machines)                                                                                                                            |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatClientBytesIn        | .1.3.6.1.4.1.3375.2.1.1.2.21.4    | The number of bytes received by the system from client-side                                                                                                                         |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatClientBytesOut       | .1.3.6.1.4.1.3375.2.1.1.2.21.6    | The number of bytes sent to client-side from the system                                                                                                                             |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatClientCurConns       | .1.3.6.1.4.1.3375.2.1.1.2.21.9    | The current connections from client-side to the system                                                                                                                              |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatClientTotConns       | .1.3.6.1.4.1.3375.2.1.1.2.21.8    | The total connections from client-side to the system                                                                                                                                |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatHttpRequests         | .1.3.6.1.4.1.3375.2.1.1.2.21.33   | The total number of HTTP requests to the system                                                                                                                                     |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatMemoryTotal          | .1.3.6.1.4.1.3375.2.1.1.2.21.28   | The total memory available in bytes for TMM (Traffic Management Module)                                                                                                             |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatMemoryUsed           | .1.3.6.1.4.1.3375.2.1.1.2.21.29   | The memory in use in bytes for TMM (Traffic Management Module)                                                                                                                      |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatServerBytesIn        | .1.3.6.1.4.1.3375.2.1.1.2.21.11   | The number of bytes received by the system from server-side                                                                                                                         |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatServerBytesOut       | .1.3.6.1.4.1.3375.2.1.1.2.21.13   | The number of bytes sent to server-side from the system                                                                                                                             |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatServerCurConns       | .1.3.6.1.4.1.3375.2.1.1.2.21.16   | The current connections from server-side to the system                                                                                                                              |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatServerTotConns       | .1.3.6.1.4.1.3375.2.1.1.2.21.15   | The total connections from server-side to the system                                                                                                                                |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatTmUsageRatio1m       | .1.3.6.1.4.1.3375.2.1.1.2.21.35   | The percentage of time all TMMs were busy over the last 1 minute                                                                                                                    |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatTmUsageRatio5m       | .1.3.6.1.4.1.3375.2.1.1.2.21.36   | The percentage of time all TMMs were busy over the last 1 minute                                                                                                                    |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatTmUsageRatio5s       | .1.3.6.1.4.1.3375.2.1.1.2.21.34   | The percentage of time all TMMs were busy over the last 5 seconds                                                                                                                   |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysConnPoolStatConnects              | .1.3.6.1.4.1.3375.2.1.1.2.3.5     | The number of connections established                                                                                                                                               |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysConnPoolStatCurSize               | .1.3.6.1.4.1.3375.2.1.1.2.3.2     | The number of currently idle connections in pools on the system                                                                                                                     |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysConnPoolStatMaxSize               | .1.3.6.1.4.1.3375.2.1.1.2.3.3     | The number of idle connections in pools on the system                                                                                                                               |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysConnPoolStatReuses                | .1.3.6.1.4.1.3375.2.1.1.2.3.4     | The number of times a connection was reused from pools on the system                                                                                                                |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatClientPktsOut        | .1.3.6.1.4.1.3375.2.1.1.2.21.5    | The number of packets sent to client-side from the system                                                                                                                           |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatClientPktsIn         | .1.3.6.1.4.1.3375.2.1.1.2.21.3    | The number of packets received by the system from client-side                                                                                                                       |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatClientMaxConns       | .1.3.6.1.4.1.3375.2.1.1.2.21.7    | The maximum connections from client-side to the system                                                                                                                              |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatServerPktsOut        | .1.3.6.1.4.1.3375.2.1.1.2.21.12   | The number of packets sent to server-side from the system                                                                                                                           |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatServerPktsIn         | .1.3.6.1.4.1.3375.2.1.1.2.21.10   | The number of packets received by the system from server-side                                                                                                                       |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatServerMaxConns       | .1.3.6.1.4.1.3375.2.1.1.2.21.14   | The maximum connections from server-side to the system                                                                                                                              |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatDroppedPackets       | .1.3.6.1.4.1.3375.2.1.1.2.21.30   | The total dropped packets                                                                                                                                                           |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatIncomingPacketErrors | .1.3.6.1.4.1.3375.2.1.1.2.21.31   | The total incoming packet errors for the system                                                                                                                                     |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
#| sysGlobalTmmStatOutgoingPacketErrors | .1.3.6.1.4.1.3375.2.1.1.2.21.32   | The total outgoing packet errors for the system                                                                                                                                     |  |  |  |  |
#+--------------------------------------+-----------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+--+--+--+
require 'sensu-plugin/metric/cli'
require 'snmp'

# Class that collects and outputs SNMP metrics in graphite format
class MetricsSwitchvox < Sensu::Plugin::Metric::CLI::Graphite
  option :host,
         short: '-h host',
         boolean: true,
         default: '127.0.0.1',
         required: true

  option :community,
         short: '-C snmp community',
         boolean: true,
         default: 'public'

  option :prefix,
         short: '-p prefix',
         description: 'prefix to attach to graphite path',
         default: 'sensu'

  option :snmp_version,
         short: '-v version',
         description: 'SNMP version to use (SNMPv1, SNMPv2c (default))',
         default: 'SNMPv2c'

  option :graphite,
         short: '-g',
         description: 'Replace dots with underscores in hostname',
         boolean: true

  option :mibdir,
         short: '-d mibdir',
         description: 'Full path to custom MIB directory.'

  option :mibs,
         short: '-l mib[,mib,mib...]',
         description: 'Custom MIBs to load (from custom mib path).',
         default: ''

  def run
    metrics = {
      '1.3.6.1.4.1.3375.2.1.7.5.2.1.11' => 'cpu.load',
      '1.3.6.1.4.1.3375.2.1.1.2.1.45.0' => 'tmm.mem.used',
      '1.3.6.1.4.1.3375.2.1.1.2.1.44.0' => 'tmm.mem.total',
      '1.3.6.1.4.1.3375.2.1.1.2.20.47.0' => 'swap.used',
      '1.3.6.1.4.1.3375.2.1.1.2.20.46.0' => 'swap.total',
      '1.3.6.1.4.1.3375.2.1.1.2.9.2.0' => 'active.client.connections.ssl',
      '1.3.6.1.4.1.3375.2.1.1.2.21.6.0' => 'tmm.client.bytes.out',
      '1.3.6.1.4.1.3375.2.1.1.2.21.4.0' => 'tmm.client.bytes.in',
      '1.3.6.1.4.1.3375.2.1.1.2.21.5.0' => 'tmm.client.packets.out',
      '1.3.6.1.4.1.3375.2.1.1.2.21.3.0' => 'tmm.client.packets.in',
      '1.3.6.1.4.1.3375.2.1.1.2.21.7.0' => 'tmm.client.conns.max',
      '1.3.6.1.4.1.3375.2.1.1.2.21.8.0' => 'tmm.client.conns.current',
      '1.3.6.1.4.1.3375.2.1.1.2.21.9.0' => 'tmm.client.conns.total',
      '1.3.6.1.4.1.3375.2.1.1.2.21.10.0' => 'tmm.server.packets.in',
      '1.3.6.1.4.1.3375.2.1.1.2.21.11.0' => 'tmm.server.bytes.in',
      '1.3.6.1.4.1.3375.2.1.1.2.21.12.0' => 'tmm.server.packets.out',
      '1.3.6.1.4.1.3375.2.1.1.2.21.13.0' => 'tmm.server.bytes.out',
      '1.3.6.1.4.1.3375.2.1.1.2.21.14.0' => 'tmm.server.conns.max',
      '1.3.6.1.4.1.3375.2.1.1.2.21.15.0' => 'tmm.server.conns.total',
      '1.3.6.1.4.1.3375.2.1.1.2.21.16.0' => 'tmm.server.conns.current',
      '1.3.6.1.4.1.3375.2.1.1.2.21.28.0' => 'tmm.memory.total',
      '1.3.6.1.4.1.3375.2.1.1.2.21.29.0' => 'tmm.memory.used'
    }

    metrics.each do |objectid, suffix|
      mibs = config[:mibs].split(',')

      host = config[:host]
      host = config[:host].tr('.', '_') if config[:graphite]

      begin
        manager = SNMP::Manager.new(host: config[:host].to_s, community: config[:community].to_s, version: config[:snmp_version].to_sym)
        if config[:mibdir] && !mibs.empty?
          manager.load_modules(mibs, config[:mibdir])
        end
        manager.get([objectid.to_s]).each_varbind do |vbg|
          if vbg.value.to_s !~ /noSuchInstance/
            if config[:prefix]
              output "#{config[:prefix]}.#{host}.#{suffix}", vbg.value.to_s
            else
              output "#{host}.#{suffix}", vbg.value.to_s
            end
          else
            counter = 0
            manager.walk([objectid.to_s]) do |index|
              counter += 1
              index.each do |vbw|
                if config[:prefix]
                  output "#{config[:prefix]}.#{host}.#{suffix}.#{counter}", vbw.value.to_s
                else
                  output "#{host}.#{suffix}", vbw.value.to_s
                end
              end
            end
          end
        end

      rescue SNMP::RequestTimeout
        unknown "#{config[:host]} not responding"
      rescue => e
        unknown "An unknown error occured: #{e.inspect}"
      end

      manager.close
    end
    ok
  end
end
